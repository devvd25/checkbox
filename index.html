<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Qu·∫£n l√Ω User</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background:#f8f9fa; }
    .dashboard { margin-top:20px; }
    .table-summary { background:#e9ecef; font-weight:bold; }
    .icon-btn { cursor:pointer; margin-left:8px; color:#0d6efd; }
    .stat-card { min-width: 260px; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h1 class="text-center mb-4">üìã Qu·∫£n l√Ω User</h1>

    <!-- Thanh c√¥ng c·ª• -->
    <div class="row g-2 mb-2">
      <div class="col-12 col-md-3">
        <input type="text" id="userInput" class="form-control" placeholder="Nh·∫≠p t√™n user..."/>
      </div>
      <div class="col-6 col-md-auto d-grid d-md-block">
        <button class="btn btn-primary w-100" onclick="addUser()">‚ûï Th√™m User</button>
      </div>
      <div class="col-6 col-md-auto d-grid d-md-block">
        <button class="btn btn-success w-100" onclick="saveHistory()">üíæ L∆∞u l·ªãch s·ª≠</button>
      </div>
      <div class="col-12 col-md-auto d-grid d-md-block">
        <button class="btn btn-info w-100" onclick="viewHistory()">üìÖ Xem l·ªãch s·ª≠</button>
      </div>
      <div class="col-12 col-md-3">
        <div class="input-group">
          <span class="input-group-text">L·ªçc tag</span>
          <select id="filterTag" class="form-select" onchange="applyFilterTag(this.value)"></select>
        </div>
      </div>
    </div>

    <!-- B·∫£ng users -->
    <div class="card shadow-sm">
      <div class="card-body">
        <table class="table table-striped table-hover" id="userTable">
          <thead class="table-dark">
            <tr>
              <th>User</th>
              <th>Ho√†n th√†nh</th>
              <th>S·ªë l·∫ßn Comment</th>
              <th>Note</th>
              <th>Hashtag</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard">
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="card shadow-sm stat-card">
            <div class="card-body">
              <h5 class="card-title">üìä T·ªïng quan</h5>
              <p id="totalComments" class="fs-5 mb-0">
                T·ªïng s·ªë comment: 0
                <span class="icon-btn" onclick="viewUserComments()" title="Xem chi ti·∫øt">üëÅ</span>
              </p>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6 class="mb-3">üè∑Ô∏è Th·ªëng k√™ theo Hashtag</h6>
              <div class="table-responsive">
                <table class="table table-bordered table-sm align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Hashtag</th><th>S·ªë user</th><th>T·ªïng comment</th>
                    </tr>
                  </thead>
                  <tbody id="tagStatsBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: L·ªãch s·ª≠ -->
  <div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üìÖ L·ªãch s·ª≠ theo tu·∫ßn / th√°ng / nƒÉm</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"><div id="historyContent"></div></div>
    </div></div>
  </div>

  <!-- Modal: Chi ti·∫øt user -->
  <div class="modal fade" id="userCommentsModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üë• Chi ti·∫øt comment theo user</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered">
          <thead class="table-light"><tr><th>User</th><th>S·ªë comment</th><th>Hashtag</th><th>Note</th></tr></thead>
          <tbody id="userCommentsBody"></tbody>
        </table>
      </div>
    </div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let users = [], tags = ["XS","11PRM"], currentFilterTag = "";

    function todayKey(){ return new Date().toLocaleDateString("vi-VN"); }

    // === Users ===
    function saveUsers(){ localStorage.setItem("users",JSON.stringify(users)); }
    function loadUsers(){
      const data=localStorage.getItem("users"); if(data) users=JSON.parse(data);
      const lastDate=localStorage.getItem("lastDate");
      const today=todayKey();
      if(lastDate && lastDate!==today){
        saveHistory(true,lastDate);
        users=users.map(u=>({...u,comments:0,completed:false}));
        saveUsers();
      }
      localStorage.setItem("lastDate",today);

      renderFilterOptions();
      renderTable();
      updateDashboard();
    }
    function addUser(){
      let n=document.getElementById("userInput").value.trim(); if(!n)return;
      users.push({name:n,completed:false,comments:0,tag:"",note:""});
      document.getElementById("userInput").value="";
      renderTable(); updateDashboard();
    }
    function deleteUser(i){ users.splice(i,1); renderTable(); updateDashboard();}
    function toggleComplete(i){ users[i].completed=!users[i].completed; saveUsers();}
    function updateComment(i,v){ users[i].comments=parseInt(v)||0; updateDashboard();}
    function updateUserTag(i,v){ users[i].tag=v; saveUsers(); updateDashboard(); }
    function updateNote(i,v){ users[i].note=v; saveUsers(); }

    // === Filter ===
    function renderFilterOptions(){
      const sel=document.getElementById("filterTag");
      sel.innerHTML=`<option value="">All</option>`+
        tags.map(t=>`<option value="${t}" ${currentFilterTag===t?"selected":""}>${t}</option>`).join("")+
        `<option value="(none)" ${currentFilterTag==="(none)"?"selected":""}>(kh√¥ng)</option>`;
    }
    function applyFilterTag(val){ currentFilterTag=val; renderTable(); }
    function userPassFilter(u){
      if(currentFilterTag==="")return true;
      if(currentFilterTag==="(none)")return !u.tag;
      return u.tag===currentFilterTag;
    }

    // === Render b·∫£ng users ===
    function renderTable(){
      const tbody=document.querySelector("#userTable tbody"); tbody.innerHTML="";
      const baseOptions=['<option value="">(kh√¥ng)</option>'].concat(tags.map(t=>`<option value="${t}">${t}</option>`)).join("");
      users.forEach((u,i)=>{ if(!userPassFilter(u))return;
        const options=baseOptions.replace(`value="${u.tag}"`,`value="${u.tag}" selected`);
        tbody.insertAdjacentHTML("beforeend",`<tr>
          <td>${u.name}</td>
          <td><input class="form-check-input" type="checkbox" ${u.completed?"checked":""} onclick="toggleComplete(${i})"></td>
          <td><input type="number" class="form-control text-center" value="${u.comments}" min="0" onchange="updateComment(${i}, this.value)"></td>
          <td><input type="text" class="form-control" value="${u.note||""}" placeholder="Ghi ch√∫..." onchange="updateNote(${i}, this.value)"></td>
          <td><select class="form-select" onchange="updateUserTag(${i}, this.value)">${options}</select></td>
          <td><button class="btn btn-danger btn-sm" onclick="deleteUser(${i})">üóëÔ∏è</button></td></tr>`);
      });
      saveUsers();
    }

    // === Dashboard ===
    function computeTagStats(){
      const all=["(kh√¥ng)",...tags], stats={};
      all.forEach(t=>stats[t]={users:0,comments:0});
      users.forEach(u=>{
        const key=u.tag||"(kh√¥ng)";
        stats[key].users++;
        stats[key].comments+=(u.comments||0);
      });
      return stats;
    }
    function renderTagStats(){
      const s=computeTagStats(), body=document.getElementById("tagStatsBody"); body.innerHTML="";
      Object.keys(s).forEach(k=>{
        body.insertAdjacentHTML("beforeend",`<tr><td>${k}</td><td>${s[k].users}</td><td>${s[k].comments}</td></tr>`);
      });
    }
    function updateDashboard(){
      const total=users.reduce((s,u)=>s+(u.comments||0),0);
      document.getElementById("totalComments").innerHTML="T·ªïng s·ªë comment: "+total+' <span class="icon-btn" onclick="viewUserComments()">üëÅ</span>';
      renderTagStats(); saveUsers();
    }

    // === History ===
    function saveHistory(silent=false,dateOverride=null){
      const key=dateOverride||todayKey(), hist=JSON.parse(localStorage.getItem("history")||"{}");
      const total=users.reduce((s,u)=>s+(u.comments||0),0);
      hist[key]={users, totalComments:total, savedAt:Date.now()};
      localStorage.setItem("history",JSON.stringify(hist));
      if(!silent) alert("‚úÖ ƒê√£ l∆∞u l·ªãch s·ª≠ ng√†y "+key);
    }
    function getWeekRange(date){
      const d=new Date(date), day=d.getDay();
      const diff=(day===0?-6:1)-day;
      const monday=new Date(d); monday.setDate(d.getDate()+diff);
      const sunday=new Date(monday); sunday.setDate(monday.getDate()+6);
      return {key:monday.toISOString().slice(0,10), text:monday.toLocaleDateString("vi-VN")+" - "+sunday.toLocaleDateString("vi-VN")};
    }
    function deleteWeek(yearKey,monthKey,weekKey){
      const hist=JSON.parse(localStorage.getItem("history")||"{}");
      for(const dstr in hist){
        const [dd,mm,yyyy]=dstr.split("/");
        const d=new Date(yyyy,mm-1,dd);
        const yk=d.getFullYear()+"", mk=(d.getMonth()+1)+"", wk=getWeekRange(d).key;
        if(yk===yearKey && mk===monthKey && wk===weekKey){ delete hist[dstr]; }
      }
      localStorage.setItem("history",JSON.stringify(hist));
      location.reload();
    }
    function deleteMonth(yearKey,monthKey){
      const hist=JSON.parse(localStorage.getItem("history")||"{}");
      for(const dstr in hist){
        const [dd,mm,yyyy]=dstr.split("/");
        const d=new Date(yyyy,mm-1,dd);
        if(d.getFullYear()==yearKey && (d.getMonth()+1)==monthKey){ delete hist[dstr]; }
      }
      localStorage.setItem("history",JSON.stringify(hist));
      location.reload();
    }
    function deleteYear(yearKey){
      const hist=JSON.parse(localStorage.getItem("history")||"{}");
      for(const dstr in hist){
        const [dd,mm,yyyy]=dstr.split("/");
        if(yyyy==yearKey){ delete hist[dstr]; }
      }
      localStorage.setItem("history",JSON.stringify(hist));
      location.reload();
    }
    function viewHistory(){
      const hist=JSON.parse(localStorage.getItem("history")||"{}");
      const c=document.getElementById("historyContent"); c.innerHTML="";
      if(Object.keys(hist).length===0){ c.innerHTML="<p>Ch∆∞a c√≥ l·ªãch s·ª≠</p>"; }
      else{
        const yearly={};
        for(const dstr in hist){
          const [dd,mm,yyyy]=dstr.split("/"); const d=new Date(yyyy,mm-1,dd);
          const yk=d.getFullYear(), mk=d.getMonth()+1, wk=getWeekRange(d);
          if(!yearly[yk]) yearly[yk]={};
          if(!yearly[yk][mk]) yearly[yk][mk]={};
          if(!yearly[yk][mk][wk.key]) yearly[yk][mk][wk.key]={range:wk.text,total:0};
          yearly[yk][mk][wk.key].total+=hist[dstr].totalComments;
        }
        Object.keys(yearly).sort().forEach(year=>{
          c.insertAdjacentHTML("beforeend",
            `<h4 class="mt-3">üìÖ NƒÉm ${year} 
              <button class="btn btn-sm btn-danger ms-2" onclick="deleteYear('${year}')">‚ùå X√≥a nƒÉm</button>
            </h4>`);
          Object.keys(yearly[year]).sort((a,b)=>a-b).forEach(month=>{
            let html=`<h5 class="mt-2">Th√°ng ${month}</h5><table class="table table-bordered"><thead class="table-light"><tr><th>Tu·∫ßn</th><th>T·ªïng Comment</th><th>H√†nh ƒë·ªông</th></tr></thead><tbody>`;
            let total=0;
            Object.keys(yearly[year][month]).forEach(week=>{
              const row=yearly[year][month][week]; total+=row.total;
              html+=`<tr><td>${row.range}</td><td>${row.total}</td><td><button class="btn btn-sm btn-danger" onclick="deleteWeek('${year}','${month}','${week}')">‚ùå X√≥a tu·∫ßn</button></td></tr>`;
            });
            html+=`<tr class="table-summary"><td>T·ªïng th√°ng ${month}</td><td>${total}</td><td><button class="btn btn-sm btn-danger" onclick="deleteMonth('${year}','${month}')">‚ùå X√≥a th√°ng</button></td></tr></tbody></table>`;
            c.insertAdjacentHTML("beforeend",html);
          });
        });
      }
      new bootstrap.Modal(document.getElementById("historyModal")).show();
    }

    // === Modal chi ti·∫øt user ===
    function viewUserComments(){
      const tb=document.getElementById("userCommentsBody"); tb.innerHTML="";
      if(users.length===0) tb.innerHTML="<tr><td colspan='4'>Ch∆∞a c√≥ user</td></tr>";
      else users.forEach(u=>
        tb.insertAdjacentHTML("beforeend",`<tr><td>${u.name}</td><td>${u.comments}</td><td>${u.tag||"(kh√¥ng)"}</td><td>${u.note||""}</td></tr>`));
      new bootstrap.Modal(document.getElementById("userCommentsModal")).show();
    }

    window.onload=loadUsers;
  </script>
</body>
</html>
