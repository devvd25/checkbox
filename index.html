<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Qu·∫£n l√Ω User</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background:#f8f9fa; }
    .dashboard { margin-top:20px; }
    .table-summary { background:#e9ecef; font-weight:bold; }
    .icon-btn { cursor:pointer; margin-left:8px; color:#0d6efd; }
    .tag-badge { margin:0 4px 4px 0; }
    .stat-card { min-width: 260px; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h1 class="text-center mb-4">üìã Qu·∫£n l√Ω User</h1>

    <!-- Thanh c√¥ng c·ª• -->
    <div class="row g-2 mb-3">
      <div class="col-12 col-md-4">
        <input type="text" id="userInput" class="form-control" placeholder="Nh·∫≠p t√™n user..."/>
      </div>
      <div class="col-12 col-md-auto d-grid d-md-block">
        <button class="btn btn-primary w-100" onclick="addUser()">‚ûï Th√™m User</button>
      </div>
      <div class="col-6 col-md-auto d-grid d-md-block">
        <button class="btn btn-success w-100" onclick="saveHistory()">üíæ L∆∞u l·ªãch s·ª≠ h√¥m nay</button>
      </div>
      <div class="col-6 col-md-auto d-grid d-md-block">
        <button class="btn btn-info w-100" onclick="viewHistory()">üìÖ Xem l·ªãch s·ª≠</button>
      </div>
      <!-- B·ªô l·ªçc hashtag -->
      <div class="col-12 col-md-3">
        <div class="input-group">
          <span class="input-group-text">L·ªçc tag</span>
          <select id="filterTag" class="form-select" onchange="applyFilterTag(this.value)"></select>
        </div>
      </div>
    </div>

    <!-- B·∫£ng users -->
    <div class="card shadow-sm">
      <div class="card-body">
        <table class="table table-striped table-hover" id="userTable">
          <thead class="table-dark">
            <tr>
              <th>User</th>
              <th>Ho√†n th√†nh</th>
              <th>S·ªë l·∫ßn Comment</th>
              <th>Hashtag</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard">
      <div class="row g-3">
        <div class="col-12 col-lg-4">
          <div class="card shadow-sm stat-card">
            <div class="card-body">
              <h5 class="card-title">üìä T·ªïng quan</h5>
              <p id="totalComments" class="fs-5 mb-0">
                T·ªïng s·ªë comment: 0
                <span class="icon-btn" onclick="viewUserComments()" title="Xem chi ti·∫øt">üëÅ</span>
              </p>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-8">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6 class="mb-3">üè∑Ô∏è Th·ªëng k√™ theo Hashtag</h6>
              <div class="table-responsive">
                <table class="table table-bordered table-sm align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th style="width:35%">Hashtag</th>
                      <th style="width:25%">S·ªë user</th>
                      <th style="width:40%">T·ªïng comment</th>
                    </tr>
                  </thead>
                  <tbody id="tagStatsBody"></tbody>
                </table>
              </div>
              <small class="text-muted d-block mt-2">* Bao g·ªìm (kh√¥ng) cho c√°c user ch∆∞a g√°n hashtag.</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: L·ªãch s·ª≠ tu·∫ßn & th√°ng -->
  <div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üìÖ L·ªãch s·ª≠ theo tu·∫ßn & th√°ng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"><div id="historyContent"></div></div>
    </div></div>
  </div>

  <!-- Modal: Chi ti·∫øt comment theo user -->
  <div class="modal fade" id="userCommentsModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üë• Chi ti·∫øt comment theo user</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered">
          <thead class="table-light">
            <tr><th>User</th><th>S·ªë comment</th><th>Hashtag</th></tr>
          </thead>
          <tbody id="userCommentsBody"></tbody>
        </table>
      </div>
    </div></div>
  </div>

  <!-- Modal: Tag Manager -->
  <div class="modal fade" id="tagManagerModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üè∑Ô∏è Qu·∫£n l√Ω Hashtag</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3 d-flex gap-2">
          <input type="text" id="newTagInput" class="form-control" placeholder="Nh·∫≠p hashtag m·ªõi (v√≠ d·ª•: SALE)"/>
          <button class="btn btn-primary" onclick="addNewTag()">Ôºã Th√™m</button>
        </div>
        <div id="tagList" class="d-flex flex-wrap"></div>
        <small class="text-muted d-block mt-2">* X√≥a hashtag s·∫Ω b·ªè g√°n ·ªü c√°c user ƒëang d√πng hashtag ƒë√≥.</small>
      </div>
    </div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let users = [];
    let tags  = [];
    let currentFilterTag = ""; // "" = All

    // ---------- Tags ----------
    function initTags() {
      const saved = localStorage.getItem("tags");
      if (saved) tags = JSON.parse(saved);
      else {
        tags = ["XS","11PRM"];
        localStorage.setItem("tags", JSON.stringify(tags));
      }
      renderFilterOptions();
    }
    function saveTags(){ localStorage.setItem("tags", JSON.stringify(tags)); }
    function renderFilterOptions(){
      const sel = document.getElementById("filterTag");
      sel.innerHTML = `<option value="">All</option>` +
        tags.map(t=>`<option value="${t}" ${currentFilterTag===t?"selected":""}>${t}</option>`).join("") +
        `<option value="(none)" ${currentFilterTag==="(none)"?"selected":""}>(kh√¥ng)</option>`;
    }

    // ---------- Users ----------
    function saveUsers(){ localStorage.setItem("users", JSON.stringify(users)); }
    function loadUsers(){
      initTags();
      const data = localStorage.getItem("users");
      if (data) users = JSON.parse(data);
      renderTable();
      updateDashboard();
    }
    function addUser(){
      const input = document.getElementById("userInput");
      const name = (input.value||"").trim();
      if (!name) return;
      users.push({ name, completed:false, comments:0, tag:"" });
      input.value = "";
      renderTable();
      updateDashboard();
    }
    function deleteUser(i){
      users.splice(i,1);
      renderTable();
      updateDashboard();
    }
    function toggleComplete(i){
      users[i].completed = !users[i].completed;
      saveUsers();
    }
    function updateComment(i, v){
      users[i].comments = parseInt(v)||0;
      updateDashboard();
    }
    function updateUserTag(i, v){
      users[i].tag = v;
      saveUsers();
      updateDashboard(); // ƒë·ªÉ th·ªëng k√™ theo tag c·∫≠p nh·∫≠t ngay
    }

    // ---------- L·ªçc theo hashtag ----------
    function applyFilterTag(val){
      currentFilterTag = val;
      renderTable();
    }
    function userPassFilter(u){
      if (currentFilterTag === "") return true; // All
      if (currentFilterTag === "(none)") return !u.tag;
      return u.tag === currentFilterTag;
    }

    // ---------- Render b·∫£ng users ----------
    function renderTable(){
      const tbody = document.querySelector("#userTable tbody");
      tbody.innerHTML = "";
      // Build dropdown options
      const baseOptions = ['<option value="">(kh√¥ng)</option>'].concat(
        tags.map(t=>`<option value="${t}">${t}</option>`)
      ).join("");
      users.forEach((u,i)=>{
        if (!userPassFilter(u)) return;
        const options = baseOptions.replace(
          `value="${u.tag}"`,
          `value="${u.tag}" selected`
        );
        const row = `
          <tr>
            <td>${u.name}</td>
            <td><input class="form-check-input" type="checkbox" ${u.completed?"checked":""} onclick="toggleComplete(${i})"></td>
            <td><input type="number" class="form-control text-center" value="${u.comments}" min="0" onchange="updateComment(${i}, this.value)"></td>
            <td style="min-width:160px;">
              <div class="input-group">
                <select class="form-select" onchange="updateUserTag(${i}, this.value)">${options}</select>
                <button class="btn btn-outline-primary" type="button" title="Qu·∫£n l√Ω hashtag" onclick="openTagManager()">Ôºã</button>
              </div>
            </td>
            <td><button class="btn btn-danger btn-sm" onclick="deleteUser(${i})">üóëÔ∏è X√≥a</button></td>
          </tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });
      saveUsers();
    }

    // ---------- Tag Manager ----------
    function openTagManager(){ renderTagList(); new bootstrap.Modal('#tagManagerModal').show(); }
    function renderTagList(){
      const box = document.getElementById("tagList");
      box.innerHTML = "";
      if (tags.length===0){ box.innerHTML = '<span class="text-muted">Ch∆∞a c√≥ hashtag n√†o.</span>'; return; }
      tags.forEach((t,idx)=>{
        const el = document.createElement("div");
        el.className = "badge text-bg-secondary tag-badge d-flex align-items-center";
        el.innerHTML = `<span>${t}</span><button class="btn btn-sm btn-light ms-2 py-0" onclick="deleteTag(${idx})">‚úï</button>`;
        box.appendChild(el);
      });
    }
    function addNewTag(){
      const ip = document.getElementById("newTagInput");
      let v = (ip.value||"").trim().replace(/\s+/g,"");
      if (!v || tags.includes(v)) { ip.value=""; return; }
      tags.push(v); saveTags(); ip.value="";
      renderTagList(); renderFilterOptions(); renderTable(); updateDashboard();
    }
    function deleteTag(index){
      const removed = tags.splice(index,1)[0];
      users = users.map(u => u.tag===removed ? {...u, tag:""} : u);
      saveTags(); saveUsers();
      renderTagList(); renderFilterOptions(); renderTable(); updateDashboard();
    }

    // ---------- Dashboard ----------
    function computeTagStats(){
      // T·∫≠p h·ª£p t·∫•t c·∫£ nh√£n g·ªìm: (kh√¥ng) + c√°c tag hi·ªán c√≥
      const allTags = ["(kh√¥ng)", ...tags];
      const stats = {};
      allTags.forEach(t=>stats[t]={ users:0, comments:0 });
      users.forEach(u=>{
        const key = u.tag ? u.tag : "(kh√¥ng)";
        stats[key].users += 1;
        stats[key].comments += (parseInt(u.comments)||0);
      });
      return stats;
    }
    function renderTagStats(){
      const stats = computeTagStats();
      const body = document.getElementById("tagStatsBody");
      body.innerHTML = "";
      Object.keys(stats).forEach(k=>{
        body.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${k}</td>
            <td>${stats[k].users}</td>
            <td>${stats[k].comments}</td>
          </tr>`);
      });
    }
    function updateDashboard(){
      const total = users.reduce((s,u)=> s+(parseInt(u.comments)||0), 0);
      document.getElementById("totalComments").innerHTML =
        "T·ªïng s·ªë comment: " + total +
        ' <span class="icon-btn" onclick="viewUserComments()" title="Xem chi ti·∫øt">üëÅ</span>';
      renderTagStats();
      saveUsers();
    }

    // ---------- L·ªãch s·ª≠ (ng√†y ‚Üí tu·∫ßn ‚Üí th√°ng) ----------
    function saveHistory(){
      const today = new Date();
      const key = today.toLocaleDateString("vi-VN"); // dd/mm/yyyy
      const history = JSON.parse(localStorage.getItem("history")||"{}");
      const total = users.reduce((s,u)=> s+(parseInt(u.comments)||0), 0);
      history[key] = { users, totalComments: total };
      localStorage.setItem("history", JSON.stringify(history));
      alert("‚úÖ ƒê√£ l∆∞u l·ªãch s·ª≠ ng√†y " + key);
    }
    function getWeekRange(date){
      const d = new Date(date);
      const day = d.getDay();
      const diffToMonday = (day===0 ? -6 : 1) - day;
      const monday = new Date(d); monday.setDate(d.getDate()+diffToMonday);
      const sunday = new Date(monday); sunday.setDate(monday.getDate()+6);
      return { key: monday.toISOString().slice(0,10),
               text: monday.toLocaleDateString("vi-VN")+" - "+sunday.toLocaleDateString("vi-VN") };
    }
    function deleteWeek(monthKey, weekKey){
      const history = JSON.parse(localStorage.getItem("history")||"{}");
      for (const dateStr in history){
        const [dd,mm,yyyy] = dateStr.split("/");
        const d = new Date(yyyy, mm-1, dd);
        const mk = (d.getMonth()+1)+"/"+d.getFullYear();
        const wk = getWeekRange(d);
        if (mk===monthKey && wk.key===weekKey) delete history[dateStr];
      }
      localStorage.setItem("history", JSON.stringify(history));
      viewHistory();
    }
    function deleteMonth(monthKey){
      const history = JSON.parse(localStorage.getItem("history")||"{}");
      for (const dateStr in history){
        const [dd,mm,yyyy] = dateStr.split("/");
        const d = new Date(yyyy, mm-1, dd);
        const mk = (d.getMonth()+1)+"/"+d.getFullYear();
        if (mk===monthKey) delete history[dateStr];
      }
      localStorage.setItem("history", JSON.stringify(history));
      viewHistory();
    }
    function viewHistory(){
      const history = JSON.parse(localStorage.getItem("history")||"{}");
      const container = document.getElementById("historyContent");
      container.innerHTML = "";
      if (Object.keys(history).length===0){
        container.innerHTML = "<p>Ch∆∞a c√≥ l·ªãch s·ª≠</p>";
      } else {
        const monthlyData = {};
        for (const dateStr in history){
          const [dd,mm,yyyy] = dateStr.split("/");
          const d = new Date(yyyy, mm-1, dd);
          const monthKey = (d.getMonth()+1)+"/"+d.getFullYear();
          const weekInfo = getWeekRange(d);
          if (!monthlyData[monthKey]) monthlyData[monthKey] = {};
          if (!monthlyData[monthKey][weekInfo.key]) {
            monthlyData[monthKey][weekInfo.key] = { range: weekInfo.text, total:0 };
          }
          monthlyData[monthKey][weekInfo.key].total += history[dateStr].totalComments;
        }
        Object.keys(monthlyData).sort((a,b)=>{
          const [ma,ya]=a.split("/").map(Number), [mb,yb]=b.split("/").map(Number);
          return ya!==yb ? ya-yb : ma-mb;
        }).forEach(month=>{
          let html = `
            <h5 class="mt-3">üìÜ Th√°ng ${month}</h5>
            <table class="table table-bordered">
              <thead class="table-light">
                <tr><th>Tu·∫ßn</th><th>T·ªïng Comment</th><th>H√†nh ƒë·ªông</th></tr>
              </thead><tbody>`;
          let monthTotal = 0;
          Object.keys(monthlyData[month]).sort().forEach(weekKey=>{
            const row = monthlyData[month][weekKey];
            monthTotal += row.total;
            html += `<tr>
              <td>${row.range}</td>
              <td>${row.total}</td>
              <td><button class="btn btn-sm btn-danger" onclick="deleteWeek('${month}','${weekKey}')">‚ùå X√≥a tu·∫ßn</button></td>
            </tr>`;
          });
          html += `<tr class="table-summary">
            <td>T·ªïng th√°ng ${month}</td>
            <td>${monthTotal}</td>
            <td><button class="btn btn-sm btn-danger" onclick="deleteMonth('${month}')">‚ùå X√≥a th√°ng</button></td>
          </tr></tbody></table>`;
          container.insertAdjacentHTML("beforeend", html);
        });
      }
      new bootstrap.Modal('#historyModal').show();
    }

    // ---------- Modal: chi ti·∫øt user ----------
    function viewUserComments(){
      const tbody = document.getElementById("userCommentsBody");
      tbody.innerHTML = "";
      if (users.length===0){
        tbody.innerHTML = "<tr><td colspan='3'>Ch∆∞a c√≥ user</td></tr>";
      } else {
        users.forEach(u=>{
          tbody.insertAdjacentHTML("beforeend", `
            <tr>
              <td>${u.name}</td>
              <td>${u.comments}</td>
              <td>${u.tag || "<i class='text-muted'>(kh√¥ng)</i>"}</td>
            </tr>`);
        });
      }
      new bootstrap.Modal('#userCommentsModal').show();
    }

    // ---------- Start ----------
    window.onload = loadUsers;
  </script>
</body>
</html>
