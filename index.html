<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω User</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f8f9fa;
    }
    .dashboard {
      margin-top: 20px;
    }
    .table-summary {
      background: #e9ecef;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h1 class="text-center mb-4">üìã Qu·∫£n l√Ω User</h1>

    <div class="d-flex mb-3">
      <input type="text" id="userInput" class="form-control me-2" placeholder="Nh·∫≠p t√™n user...">
      <button class="btn btn-primary me-2" onclick="addUser()">‚ûï Th√™m User</button>
      <button class="btn btn-success me-2" onclick="saveHistory()">üíæ L∆∞u l·ªãch s·ª≠ h√¥m nay</button>
      <button class="btn btn-info" onclick="viewHistory()">üìÖ Xem l·ªãch s·ª≠</button>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <table class="table table-striped table-hover" id="userTable">
          <thead class="table-dark">
            <tr>
              <th>User</th>
              <th>Ho√†n th√†nh</th>
              <th>S·ªë l·∫ßn Comment</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="dashboard card shadow-sm mt-4">
      <div class="card-body">
        <h5 class="card-title">üìä Dashboard</h5>
        <p id="totalComments" class="fs-5">T·ªïng s·ªë comment: 0</p>
      </div>
    </div>
  </div>

  <!-- Modal hi·ªÉn th·ªã l·ªãch s·ª≠ -->
  <div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üìÖ L·ªãch s·ª≠ theo tu·∫ßn & th√°ng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="historyContent"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let users = [];

    function updateDashboard() {
      let total = users.reduce((sum, u) => sum + (parseInt(u.comments) || 0), 0);
      document.getElementById("totalComments").innerText =
        "T·ªïng s·ªë comment: " + total;
      saveUsers();
    }

    function addUser() {
      let input = document.getElementById("userInput");
      let name = input.value.trim();
      if (name === "") return;
      let user = { name, completed: false, comments: 0 };
      users.push(user);
      input.value = "";
      renderTable();
      updateDashboard();
    }

    function toggleComplete(index) {
      users[index].completed = !users[index].completed;
      saveUsers();
    }

    function updateComment(index, value) {
      users[index].comments = parseInt(value) || 0;
      updateDashboard();
    }

    function deleteUser(index) {
      users.splice(index, 1);
      renderTable();
      updateDashboard();
    }

    function renderTable() {
      let tbody = document.querySelector("#userTable tbody");
      tbody.innerHTML = "";
      users.forEach((user, index) => {
        let row = `<tr>
          <td>${user.name}</td>
          <td><input class="form-check-input" type="checkbox" ${user.completed ? "checked" : ""} onclick="toggleComplete(${index})"></td>
          <td><input type="number" class="form-control text-center" value="${user.comments}" min="0" onchange="updateComment(${index}, this.value)"></td>
          <td><button class="btn btn-danger btn-sm" onclick="deleteUser(${index})">üóëÔ∏è X√≥a</button></td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    function saveUsers() {
      localStorage.setItem("users", JSON.stringify(users));
    }

    function loadUsers() {
      let data = localStorage.getItem("users");
      if (data) {
        users = JSON.parse(data);
        renderTable();
        updateDashboard();
      }
    }

    function saveHistory() {
      let today = new Date();
      let key = today.toLocaleDateString("vi-VN"); // dd/mm/yyyy
      let history = JSON.parse(localStorage.getItem("history") || "{}");
      let total = users.reduce((sum, u) => sum + (parseInt(u.comments) || 0), 0);
      history[key] = { users, totalComments: total };
      localStorage.setItem("history", JSON.stringify(history));
      alert("‚úÖ ƒê√£ l∆∞u l·ªãch s·ª≠ ng√†y " + key);
    }

    function getWeekRange(date) {
      let d = new Date(date);
      let day = d.getDay(); 
      let diffToMonday = (day === 0 ? -6 : 1) - day; 
      let monday = new Date(d);
      monday.setDate(d.getDate() + diffToMonday);
      let sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      return {
        key: monday.toISOString().slice(0,10),
        text: monday.toLocaleDateString("vi-VN") + " - " + sunday.toLocaleDateString("vi-VN")
      };
    }

    function viewHistory() {
      let history = JSON.parse(localStorage.getItem("history") || "{}");
      let container = document.getElementById("historyContent");
      container.innerHTML = "";

      if (Object.keys(history).length === 0) {
        container.innerHTML = "<p>Ch∆∞a c√≥ l·ªãch s·ª≠</p>";
      } else {
        // Gom theo th√°ng -> tu·∫ßn
        let monthlyData = {};
        for (let dateStr in history) {
          let parts = dateStr.split("/");
          let d = new Date(parts[2], parts[1]-1, parts[0]);
          let monthKey = (d.getMonth()+1) + "/" + d.getFullYear();
          let weekInfo = getWeekRange(d);

          if (!monthlyData[monthKey]) monthlyData[monthKey] = {};
          if (!monthlyData[monthKey][weekInfo.key]) {
            monthlyData[monthKey][weekInfo.key] = { range: weekInfo.text, total: 0 };
          }
          monthlyData[monthKey][weekInfo.key].total += history[dateStr].totalComments;
        }

        for (let month in monthlyData) {
          let html = `<h5 class="mt-3">üìÜ Th√°ng ${month}</h5>
                      <table class="table table-bordered">
                        <thead class="table-light">
                          <tr><th>Tu·∫ßn</th><th>T·ªïng Comment</th></tr>
                        </thead>
                        <tbody>`;
          let monthTotal = 0;
          for (let week in monthlyData[month]) {
            html += `<tr>
                      <td>${monthlyData[month][week].range}</td>
                      <td>${monthlyData[month][week].total}</td>
                     </tr>`;
            monthTotal += monthlyData[month][week].total;
          }
          html += `<tr class="table-summary">
                     <td>T·ªïng th√°ng ${month}</td>
                     <td>${monthTotal}</td>
                   </tr>`;
          html += "</tbody></table>";
          container.innerHTML += html;
        }
      }

      let modal = new bootstrap.Modal(document.getElementById("historyModal"));
      modal.show();
    }

    window.onload = loadUsers;
  </script>
</body>
</html>
